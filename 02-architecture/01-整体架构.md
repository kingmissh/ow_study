# OpenClaw 整体架构

## 架构设计原则

OpenClaw 采用模块化、分层的架构设计，遵循以下原则：

1. **关注点分离**：每个组件负责特定的功能
2. **可扩展性**：通过插件和技能系统扩展功能
3. **平台无关**：支持多种操作系统和消息平台
4. **异步处理**：高效处理并发请求

---

## 核心架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      用户界面层                              │
│  Telegram | WhatsApp | Discord | Slack | Web | CLI          │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    通道适配层 (Channels)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Telegram │  │ Discord  │  │  Slack   │  │   ...    │   │
│  │ Adapter  │  │ Adapter  │  │ Adapter  │  │          │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    网关层 (Gateway)                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  HTTP Server | WebSocket | Authentication           │   │
│  │  Rate Limiting | Request Routing | Session Mgmt     │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                   消息路由层 (Router)                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Message Parser | Context Builder | Agent Selector  │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                  Agent 运行时 (pi-agent-core)                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   LLM        │  │   Tool       │  │   Memory     │     │
│  │   Manager    │  │   Executor   │  │   Manager    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Context    │  │   Prompt     │  │   Response   │     │
│  │   Manager    │  │   Builder    │  │   Generator  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    工具层 (Tools)                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │   File   │  │  Shell   │  │ Browser  │  │   API    │   │
│  │  System  │  │ Executor │  │ Control  │  │  Client  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                   扩展层 (Extensions)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Skills     │  │   Plugins    │  │   Lobster    │     │
│  │   (Python/   │  │   (System    │  │  (Workflow   │     │
│  │    JS)       │  │   Extensions) │  │   Engine)    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                   存储层 (Storage)                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Session    │  │   Files      │  │   Logs       │     │
│  │   Database   │  │   Storage    │  │   Storage    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心组件详解

### 1. 通道适配层 (Channels)

**职责**：
- 与各个消息平台的 API 集成
- 消息格式转换和标准化
- 平台特定功能的封装

**关键接口**：
```typescript
interface Channel {
  name: string;
  enabled: boolean;
  
  // 初始化连接
  connect(): Promise<void>;
  
  // 发送消息
  sendMessage(userId: string, message: Message): Promise<void>;
  
  // 接收消息
  onMessage(handler: MessageHandler): void;
  
  // 断开连接
  disconnect(): Promise<void>;
}
```

**支持的平台**：
- Telegram Bot API
- Discord Bot API
- Slack API
- WhatsApp Business API
- Signal
- iMessage (通过 Shortcuts)

---

### 2. 网关层 (Gateway)

**职责**：
- HTTP/WebSocket 服务器
- 请求认证和授权
- 速率限制和防护
- 会话管理

**核心功能**：
```typescript
class Gateway {
  // HTTP 服务器
  private httpServer: HttpServer;
  
  // WebSocket 服务器
  private wsServer: WebSocketServer;
  
  // 认证中间件
  authenticate(req: Request): Promise<User>;
  
  // 路由请求
  route(req: Request): Promise<Response>;
  
  // 速率限制
  rateLimit(userId: string): boolean;
}
```

**配置选项**：
- `port`: 监听端口
- `bind`: 绑定地址（loopback/all）
- `auth.mode`: 认证模式（token/oauth）
- `tailscale`: VPN 集成

---

### 3. 消息路由层 (Router)

**职责**：
- 解析和理解消息
- 构建对话上下文
- 选择合适的 Agent
- 管理消息队列

**路由逻辑**：
```typescript
class MessageRouter {
  // 解析消息
  parseMessage(raw: RawMessage): ParsedMessage;
  
  // 构建上下文
  buildContext(message: ParsedMessage): Context;
  
  // 选择 Agent
  selectAgent(context: Context): Agent;
  
  // 路由消息
  route(message: ParsedMessage): Promise<Response>;
}
```

---

### 4. Agent 运行时 (pi-agent-core)

这是 OpenClaw 的核心，负责 AI 推理和任务执行。

**核心模块**：

#### LLM Manager
```typescript
class LLMManager {
  // 选择模型
  selectModel(task: Task): Model;
  
  // 调用模型
  invoke(prompt: Prompt, model: Model): Promise<Response>;
  
  // 处理流式响应
  stream(prompt: Prompt, model: Model): AsyncIterator<Token>;
}
```

#### Tool Executor
```typescript
class ToolExecutor {
  // 注册工具
  registerTool(tool: Tool): void;
  
  // 执行工具
  executeTool(name: string, args: any): Promise<any>;
  
  // 工具链执行
  executeChain(tools: Tool[]): Promise<any>;
}
```

#### Memory Manager
```typescript
class MemoryManager {
  // 保存记忆
  save(userId: string, memory: Memory): Promise<void>;
  
  // 检索记忆
  retrieve(userId: string, query: string): Promise<Memory[]>;
  
  // 更新记忆
  update(memoryId: string, data: any): Promise<void>;
}
```

---

### 5. 工具层 (Tools)

**内置工具**：

#### 文件系统工具
```typescript
interface FileSystemTool {
  readFile(path: string): Promise<string>;
  writeFile(path: string, content: string): Promise<void>;
  listDirectory(path: string): Promise<string[]>;
  deleteFile(path: string): Promise<void>;
}
```

#### Shell 执行工具
```typescript
interface ShellTool {
  execute(command: string): Promise<ExecutionResult>;
  executeAsync(command: string): Promise<ProcessHandle>;
}
```

#### 浏览器控制工具
```typescript
interface BrowserTool {
  navigate(url: string): Promise<void>;
  click(selector: string): Promise<void>;
  extract(selector: string): Promise<string>;
  screenshot(): Promise<Buffer>;
}
```

---

### 6. 扩展层 (Extensions)

#### Skills
- Python 或 JavaScript 编写
- 提供特定领域功能
- 可以调用外部 API
- 支持依赖管理

#### Plugins
- 系统级扩展
- 认证提供者
- 消息平台集成
- 自定义功能模块

#### Lobster
- 工作流引擎
- 类型化的宏系统
- 可组合的管道
- 安全的自动化

---

## 数据流分析

### 典型请求流程

```
1. 用户在 Telegram 发送消息
   ↓
2. Telegram Bot API 推送消息到 Gateway
   ↓
3. Gateway 验证请求并提取消息
   ↓
4. Router 解析消息并构建上下文
   ↓
5. Router 选择合适的 Agent
   ↓
6. Agent 加载会话历史和记忆
   ↓
7. Agent 构建 Prompt 并调用 LLM
   ↓
8. LLM 返回响应（可能包含工具调用）
   ↓
9. Agent 执行工具调用
   ↓
10. Agent 生成最终响应
    ↓
11. Router 将响应发送回 Gateway
    ↓
12. Gateway 通过 Channel 发送给用户
    ↓
13. 保存会话状态和记忆
```

### 并发处理

OpenClaw 支持并发处理多个请求：

```typescript
class ConcurrencyManager {
  private maxConcurrent: number;
  private activeRequests: Map<string, Request>;
  
  async process(request: Request): Promise<Response> {
    // 等待可用槽位
    await this.waitForSlot();
    
    try {
      // 处理请求
      return await this.handleRequest(request);
    } finally {
      // 释放槽位
      this.releaseSlot();
    }
  }
}
```

---

## 配置管理

### 配置文件结构

```json
{
  "meta": {
    "lastTouchedVersion": "2026.2.14",
    "lastTouchedAt": "2026-02-16T01:00:39.116Z"
  },
  "gateway": { /* 网关配置 */ },
  "channels": { /* 通道配置 */ },
  "agents": { /* Agent 配置 */ },
  "models": { /* 模型配置 */ },
  "skills": { /* 技能配置 */ },
  "plugins": { /* 插件配置 */ },
  "hooks": { /* 钩子配置 */ }
}
```

### 配置合并策略

多个配置源按优先级合并：
1. 默认配置
2. 用户级配置 (`~/.openclaw/openclaw.json`)
3. 工作空间配置 (`.openclaw/openclaw.json`)
4. 环境变量

---

## 安全架构

### 认证机制

```typescript
interface AuthProvider {
  // 验证令牌
  verifyToken(token: string): Promise<User>;
  
  // 刷新令牌
  refreshToken(refreshToken: string): Promise<Token>;
  
  // 撤销令牌
  revokeToken(token: string): Promise<void>;
}
```

### 权限控制

```typescript
interface PermissionManager {
  // 检查权限
  checkPermission(user: User, action: Action): boolean;
  
  // 授予权限
  grantPermission(user: User, permission: Permission): void;
  
  // 撤销权限
  revokePermission(user: User, permission: Permission): void;
}
```

---

## 性能优化

### 缓存策略

- **会话缓存**：内存中缓存活跃会话
- **模型响应缓存**：缓存常见查询的响应
- **工具结果缓存**：缓存幂等工具的结果

### 资源管理

```typescript
class ResourceManager {
  // 限制内存使用
  private maxMemory: number;
  
  // 限制并发请求
  private maxConcurrent: number;
  
  // 清理资源
  cleanup(): void;
}
```

---

## 学习检查点

完成本节后，你应该能够：
- [ ] 理解 OpenClaw 的整体架构
- [ ] 识别各层的职责和交互
- [ ] 理解消息处理的完整流程
- [ ] 了解核心组件的接口设计
- [ ] 理解配置管理机制

---

## 下一步

深入学习各个核心组件：
- [02-Gateway详解.md](./02-Gateway详解.md)
- [03-Agent运行时.md](./03-Agent运行时.md)
- [04-消息路由.md](./04-消息路由.md)
